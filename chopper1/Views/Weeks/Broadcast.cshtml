@model List<chopper1.Models.Day>
@{    
    string curDate = Model[0].TVDate.Date.ToString("yyyy-MM-dd");
    string curDow = @System.Globalization.DateTimeFormatInfo.CurrentInfo.GetDayName(Model[0].TVDate.DayOfWeek);
    if (curDow.Right(1)=="а") curDow = curDow.Left(curDow.Length-1)+"у";
    
    ViewBag.Title = Model[0].TVDate.Date.ToString("dd/MM/yyyy");
}

@using (Html.BeginForm("Broadcast", "Weeks", FormMethod.Get))
{
    <fieldset>
        <h2>Программа передач Первого канала на @curDow, <input name="bdate" type="date" id="broadcast_datepicker" class="datepickers" required="required" value="@curDate" onchange="form.submit();" /></h2>
    </fieldset>
}

<p id="timestampDiv">@DateTime.Now.ToString("dd/MM/yyyy") @DateTime.Now.ToString("HH:mm:ss")</p>

<div class="row week_bg">
    @{
    double dayRectWidth = 95.0 / 6;
    string dayRectWidthStr = dayRectWidth.ToString("#.##").Replace(",", ".") + "%";
    }

    @foreach (chopper1.Models.Day day in Model)
    {
        Html.RenderAction("ConstructTimeScale", "Day", new { left = true, channelCode = day.KanalKod });
        <div id="@day.TVDayRef" data-varnum="@day.VariantKod" class="dayrect" ondrop="drop(event)" ondragover="allowDrop(event)" style="width: @dayRectWidthStr;">
            @{Html.RenderAction("BroadcastDay", "Day", day);}
        </div>
    }
    @{Html.RenderAction("ConstructTimeScale", "Day", new { left = false, channelCode = 10 });}
    
</div>


@section scripts {

<script src="~/Scripts/jquery-1.10.2.min.js"></script>
<script src="~/Scripts/jquery.signalR-2.2.0.min.js"></script>
<script src="~/signalr/hubs"></script>
<script src="~/Scripts/jquery.unobtrusive-ajax.js"></script>


<script>
    $(function () {
        var dUpdate = $.connection.dayUpdate;
        var xmlhttp;
        xmlhttp = new XMLHttpRequest();


        dUpdate.client.broadcastMessage = function (tvdayref, varNum, serverTime) {
        if (tvdayref != "") {
            var xmlhttp;
            xmlhttp = new XMLHttpRequest();

            xmlhttp.onreadystatechange = function () {
                if (xmlhttp.readyState == XMLHttpRequest.DONE) {
                    console.log(tvdayref + '-' + serverTime);
                    if (xmlhttp.status == 200) {
                        document.getElementById(tvdayref).innerHTML = xmlhttp.responseText;
                        document.getElementById("timestampDiv").innerHTML = serverTime;
                    }
                    else if (xmlhttp.status == 400) {
                        console.log(xmlhttp.statusText);
                    }
                    else {
                        console.log(xmlhttp.statusText);
                        console.log(xmlhttp.responseText);
                    }
                }
            }
            xmlhttp.open("POST", "UpdateDayBroadcast", true);
            xmlhttp.setRequestHeader("dayID", tvdayref);
            xmlhttp.setRequestHeader("varNum", varNum);
            xmlhttp.send(tvdayref);
        }            
        };
        /*Added 22/06/16*/
        $.connection.hub.disconnected(function () {
            setTimeout(function () {
                $.connection.hub.start();
            }, 5000); // Restart connection after 5 seconds.
        });

        $.connection.hub.start().done(function () {
            var allDayRects1 = document.getElementsByClassName("dayrect");
            for (var i = 0; i < allDayRects1.length; i++)
            {
                dUpdate.server.subscribe(allDayRects1.item(i).id);
            }
            setInterval(function () {
                var allDayRects2 = document.getElementsByClassName("dayrect");
                for (var i = 0; i < allDayRects2.length; i++) {
                    if (allDayRects1.item(i).id != allDayRects2.item(i).id) {
                        dUpdate.server.subscribe(allDayRects2.item(i).id);                        
                    }                    
                }
                allDayRects1 = allDayRects2;
            }, 3000);
        });
    });
</script>

    @*
<script>
    $(function () {
        

        
        var xmlhttp;
        xmlhttp = new XMLHttpRequest();
        


        var dUpdate = $.connection.dayUpdate;
        dUpdate.client.broadcastMessage = function (tvdayref, varNum, serverTime) {
            
            if (tvdayref != "") {
                var xmlhttp;
                xmlhttp = new XMLHttpRequest();






                xmlhttp.onreadystatechange = function () {
                    if (xmlhttp.readyState == XMLHttpRequest.DONE) {
                        console.log(tvdayref +'-'+ serverTime);
                        if (xmlhttp.status == 200) {
                            document.getElementById(tvdayref).innerHTML = xmlhttp.responseText;
                            document.getElementById("timestampDiv").innerHTML = serverTime;
                        }
                        else if (xmlhttp.status == 400) {
                            console.log(xmlhttp.statusText);
                        }
                        else {
                            console.log(xmlhttp.statusText);
                        }
                    }
                }
                xmlhttp.open("POST", "UpdateDayBroadcast", true);
                xmlhttp.setRequestHeader("dayID", tvdayref);
                xmlhttp.setRequestHeader("varNum", varNum);
                xmlhttp.send(tvdayref);
            }
        };

        $.connection.hub.start().done(function () {
            var allDayRects1 = document.getElementsByClassName("dayrect");
            for (var i = 0; i < allDayRects1.length; i++) {                          
                dUpdate.server.subscribe(allDayRects1.item(i).id);
            }
            setInterval(function () {
                var allDayRects2 = document.getElementsByClassName("dayrect");
                var days = new Array();
                //var vars = new Array();
                var allvars = document.getElementsByClassName("varCode-div");
                var vars2 = new Array();
                for (var i = 0; i < allvars.length; i++) {
                    vars2.push(allvars.item(i).id.substring(3));
                }
                for (var i = 0; i < allDayRects2.length; i++) {
                    if (allDayRects1.item(i).id != allDayRects2.item(i).id)
                    {
                        dUpdate.server.subscribe(allDayRects2.item(i).id);
                    }
                    days.push(allDayRects2.item(i).id);
                    //vars.push(allDayRects.item(i).getAttribute('data-varnum'));
                    //dUpdate.server.subscribe(allDayRects.item(i).id);
                }
                
                var timestamp = document.getElementById("timestampDiv").innerText;
                dUpdate.server.updateDay(days, vars2, timestamp);
                
            }, 5000);
            // Call the Send method on the hub.                        
        });
    });
</script>


        *@
    }






@*old
<script>
document.addEventListener("DOMContentLoaded", function a() {
    try {
        var source = new EventSource('checkdays');
        var myP = document.getElementById("messages");

        source.onmessage = function (event) {
            var result = event.data;
            if (result != "") {
                var xmlhttp;
                xmlhttp = new XMLHttpRequest();

                xmlhttp.onreadystatechange = function () {
                    if (xmlhttp.readyState == XMLHttpRequest.DONE) {
                        console.log(result);
                        if (xmlhttp.status == 200) {
                            document.getElementById(result).innerHTML = xmlhttp.responseText;
                            document.getElementById("timestampDiv").innerHTML = getTimeStamp();
                        }
                        else if (xmlhttp.status == 400) {                            
                            console.log(xmlhttp.statusText);
                        }
                        else {
                            console.log(xmlhttp.statusText);
                        }
                    }
                }
                xmlhttp.open("POST", "UpdateDayBroadcast", true);
                xmlhttp.setRequestHeader("dayID", result);
                xmlhttp.send(result);
            }

        };
    }
    catch (err)
    {
        console.log(err.message)
    }
    source.onerror = function (e) {
    };

});

</script>
    *@



